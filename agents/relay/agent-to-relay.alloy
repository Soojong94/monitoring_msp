// ============================================
// MSP Monitoring - Agent → Relay Config
// ============================================
// Outbound 인터넷 접근이 차단된 서버용.
// 중앙 서버로 직접 push 불가 → 동일 네트워크 내 릴레이 에이전트로 push.
//
// [이 서버] → 릴레이 내부 IP:9999 → [릴레이 에이전트] → [중앙 서버]
//
// 필수 환경변수:
//   CUSTOMER_ID        : 고객사 식별자 (예: kt, naver)
//   SERVER_NAME        : 서버명 (예: kt-prod-db-01)
//   CSP                : 클라우드 종류 (aws, kt, naver, nhn)
//   REGION             : 리전 (예: ap-northeast-2, kc1)
//   ENVIRONMENT        : 환경 (prod, staging, test)
//   RELAY_URL          : 릴레이 에이전트 내부 주소 (예: http://10.0.1.5:9999/api/v1/metrics/write)

// --- OS 메트릭 수집 (node_exporter 내장) ---
prometheus.exporter.unix "node" {
  set_collectors = [
    "cpu",
    "meminfo",
    "loadavg",
    "filesystem",
    "netdev",
    "diskstats",
    "uname",
    "time",
  ]
}

// --- 15초 간격 스크래핑 ---
prometheus.scrape "node" {
  targets         = prometheus.exporter.unix.node.targets
  forward_to      = [prometheus.relabel.add_labels.receiver]
  scrape_interval = "15s"
  scrape_timeout  = "10s"
}

// --- 고객/서버/CSP 라벨 추가 ---
prometheus.relabel "add_labels" {
  forward_to = [prometheus.remote_write.relay.receiver]

  rule {
    action       = "replace"
    target_label = "customer_id"
    replacement  = env("CUSTOMER_ID")
  }

  rule {
    action       = "replace"
    target_label = "server_name"
    replacement  = env("SERVER_NAME")
  }

  rule {
    action       = "replace"
    target_label = "csp"
    replacement  = env("CSP")
  }

  rule {
    action       = "replace"
    target_label = "region"
    replacement  = env("REGION")
  }

  rule {
    action       = "replace"
    target_label = "environment"
    replacement  = env("ENVIRONMENT")
  }
}

// --- 내부 릴레이 에이전트로 push (인터넷 불필요) ---
prometheus.remote_write "relay" {
  endpoint {
    // 릴레이 내부 IP:9999 → 외부망 없이 내부 네트워크로만 전달
    url = env("RELAY_URL")

    queue_config {
      capacity             = 2500
      max_shards           = 4
      min_shards           = 1
      max_samples_per_send = 500
      batch_send_deadline  = "5s"
      min_backoff          = "30ms"
      max_backoff          = "5s"
    }
  }
}
