// ============================================
// MSP Monitoring - Direct Agent Config (Windows)
// ============================================
// Outbound 인터넷 접근이 가능한 Windows 서버용.
// 수집한 메트릭을 중앙 서버로 직접 push.
//
// 필수 환경변수:
//   CUSTOMER_ID        : 고객사 식별자 (예: kt, naver)
//   SERVER_NAME        : 서버명 (예: kt-prod-web-01)
//   CSP                : 클라우드 종류 (aws, kt, naver, nhn)
//   REGION             : 리전 (예: ap-northeast-2, kc1)
//   ENVIRONMENT        : 환경 (prod, staging, test)
//   REMOTE_WRITE_URL   : 중앙 서버 주소 (예: http://1.2.3.4:8880/api/v1/write)
//
// 수집 메트릭 (windows_* prefix):
//   windows_cpu_time_total           → CPU 사용률
//   windows_memory_*                 → 메모리
//   windows_logical_disk_*           → 디스크 용량
//   windows_net_*                    → 네트워크 트래픽
//   windows_os_*                     → OS 정보 (Uptime 등)
//   windows_system_*                 → 시스템 정보

// --- Windows OS 메트릭 수집 ---
prometheus.exporter.windows "node" {
  enabled_collectors = [
    "cpu",
    "memory",
    "logical_disk",
    "net",
    "os",
    "system",
    "time",
  ]
}

// --- 15초 간격 스크래핑 ---
prometheus.scrape "node" {
  targets         = prometheus.exporter.windows.node.targets
  forward_to      = [prometheus.relabel.add_labels.receiver]
  scrape_interval = "15s"
  scrape_timeout  = "10s"
}

// --- 고객/서버/CSP 라벨 추가 ---
prometheus.relabel "add_labels" {
  forward_to = [prometheus.remote_write.central.receiver]

  rule {
    action       = "replace"
    target_label = "customer_id"
    replacement  = env("CUSTOMER_ID")
  }

  rule {
    action       = "replace"
    target_label = "server_name"
    replacement  = env("SERVER_NAME")
  }

  rule {
    action       = "replace"
    target_label = "csp"
    replacement  = env("CSP")
  }

  rule {
    action       = "replace"
    target_label = "region"
    replacement  = env("REGION")
  }

  rule {
    action       = "replace"
    target_label = "environment"
    replacement  = env("ENVIRONMENT")
  }

  rule {
    action       = "replace"
    target_label = "os"
    replacement  = "windows"
  }
}

// --- 중앙 서버로 직접 remote_write push ---
prometheus.remote_write "central" {
  endpoint {
    url = env("REMOTE_WRITE_URL")

    queue_config {
      capacity             = 2500
      max_shards           = 4
      min_shards           = 1
      max_samples_per_send = 500
      batch_send_deadline  = "5s"
      min_backoff          = "30ms"
      max_backoff          = "5s"
    }
  }
}
