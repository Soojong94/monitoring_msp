# ============================================
# MSP Monitoring - Docker Compose (Local Test Override)
# ============================================
# 실제 Alloy 에이전트로 이 PC의 OS 메트릭을 수집하여 검증.
#
# 사용법:
#   docker compose -f docker-compose.yml -f docker-compose.local.yml --env-file .env.local up -d

services:
  # -----------------------------------------------
  # 실제 Alloy 에이전트 (이 PC의 OS 메트릭 수집 → VictoriaMetrics push)
  # -----------------------------------------------
  # 프로덕션에서는 고객 서버에 바이너리로 설치되는 것과 동일한 설정.
  # 로컬에서는 Docker 컨테이너로 실행하여 동작 검증.
  test-agent:
    image: grafana/alloy:v1.5.1
    container_name: msp-test-agent
    restart: unless-stopped
    command:
      - run
      - /etc/alloy/config.alloy
      - --stability.level=generally-available
    environment:
      - CUSTOMER_ID=test-local
      - SERVER_NAME=test-vm-01
      - ENVIRONMENT=test
      - CSP=local
      - REGION=local
      - REMOTE_WRITE_URL=http://victoriametrics:8428/api/v1/write
    volumes:
      - ./mock/alloy-test/config.alloy:/etc/alloy/config.alloy:ro
      - /:/host/root:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    networks:
      - msp-net
    depends_on:
      victoriametrics:
        condition: service_healthy

  # VictoriaMetrics: 포트 노출 + IPv6 이슈 방지
  victoriametrics:
    command:
      - '-storageDataPath=/victoria-metrics-data'
      - '-retentionPeriod=${VM_RETENTION:-90d}'
      - '-httpListenAddr=:8428'
      - '-selfScrapeInterval=15s'
      - '-dedup.minScrapeInterval=30s'
    ports:
      - "8428:8428"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8428/-/healthy"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Grafana 직접 접근 (디버깅용)
  grafana:
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Nginx: localhost → 127.0.0.1 (IPv6 이슈 방지)
  nginx:
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  vm-data:
  grafana-data:
