# ============================================
# MSP Monitoring - Docker Compose (Production)
# ============================================
# Ubuntu 중앙 서버에서 실행. 고객사 에이전트(Alloy)로부터
# remote_write로 메트릭을 수신하여 Grafana로 시각화.
#
# 서비스 구성:
#   VictoriaMetrics → 시계열 저장소 (remote_write 수신)
#   Grafana         → 대시보드 시각화
#   Nginx           → 리버스 프록시 + Basic Auth

services:
  # -----------------------------------------------
  # VictoriaMetrics: 시계열 데이터 저장
  # -----------------------------------------------
  # 에이전트(Alloy) → remote_write → :8428/api/v1/write
  # Nginx를 통해 외부에서는 :8880/api/v1/write 로 수신
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.106.1
    container_name: msp-victoriametrics
    restart: unless-stopped
    command:
      - '-storageDataPath=/victoria-metrics-data'
      - '-retentionPeriod=${VM_RETENTION:-90d}'
      - '-httpListenAddr=:8428'
      - '-selfScrapeInterval=15s'
      - '-dedup.minScrapeInterval=30s'
    volumes:
      - vm-data:/victoria-metrics-data
    networks:
      - msp-net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:8428/-/healthy"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # -----------------------------------------------
  # Grafana: 대시보드 시각화
  # -----------------------------------------------
  grafana:
    build:
      context: .
      dockerfile: docker/grafana/Dockerfile
    container_name: msp-grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-changeme}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=false
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - msp-net
    depends_on:
      victoriametrics:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # -----------------------------------------------
  # Nginx: 리버스 프록시 + Basic Auth
  # -----------------------------------------------
  # 포트 80 → Grafana (Basic Auth)
  # 포트 80 /api/v1/write → VictoriaMetrics (에이전트 수신용, 인증 없음)
  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
      args:
        BASIC_AUTH_USER: ${NGINX_BASIC_AUTH_USER:-admin}
        BASIC_AUTH_PASSWORD: ${NGINX_BASIC_AUTH_PASSWORD:-changeme}
    container_name: msp-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-8880}:80"
      - "${NGINX_HTTPS_PORT:-8443}:443"
    networks:
      - msp-net
    depends_on:
      grafana:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  msp-net:
    driver: bridge

volumes:
  vm-data:
    driver: local
  grafana-data:
    driver: local
